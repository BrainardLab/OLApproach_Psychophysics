---
title: "Adaptation to melanopic stimulation does not affect cone-mediated flicker sensitivity"
author: "Joris Vincent, Geoffrey K. Aguirre, David H. Brainard"
subtitle: Supplementary information
output:
  pdf_document: default
  word_document: default
---
```{r setup, echo=FALSE, message=FALSE}
library(tidyverse)
library(knitr)
library(stringr)
library(glue)
options(digits = 3)
source('../lib/median_SEM.R')
```
```{r merge, echo=FALSE}
csvsPath = normalizePath("../../data/processed")
csvfiles = list.files(csvsPath, recursive = TRUE, pattern = 'results_.*.csv')

results_all = lapply(csvfiles,function(x) {
   read_csv(file.path(csvsPath,x), col_types = cols())
  }) %>%
  bind_rows
```
```{r munge, echo=FALSE}
results_clean = results_all %>%
  separate(datafile,into=c("marker","participant","session","acquisition"),sep="-") %>%
  select(-marker, -acquisition) %>%
  
  # Select only relevant columns
  select(participant, session, axis, adaptationLevel, fitThresholdContrast, fitJND) %>%
  
  # Recode adaptationLevel as factor
  mutate(adaptationLevel= factor(adaptationLevel,levels=c('low','high'))) %>%

  # Rename participants
  mutate(participant = recode_factor(participant, HERO_GKA = "P1", HERO_DHB = "P2", HERO_JXV = "P3")) %>%

  # Rename sessions
  mutate(session = factor(str_replace(session,'session_',''),ordered=TRUE))
```

```{r extract_JNDs, echo=FALSE}
JNDs = results_clean %>%
  # Convert to wide-format: separate columns for high/low
  select(-fitThresholdContrast) %>%
  spread(key = adaptationLevel, value = fitJND)
```

```{r normalize_JNDs, echo=FALSE}
JNDs = JNDs %>%
  # Normalize to median(low) -- median across sessions per participant per axis
  group_by(participant,axis) %>%
  mutate(high = high/median(low),
         low = low/median(low))
```

```{r plot_JNDs, echo=FALSE}
JNDs %>% 
  # Convert back to tall: separate rows for high/low
  gather(low,high,key='adaptationLevel',value='JND') %>%
  mutate(adaptationLevel=factor(adaptationLevel,levels=c('low','high'))) %>%

  # Plot
  ggplot() +
  aes(x = adaptationLevel, y = JND) +
  facet_grid(participant ~ axis) +
  ylab("Just Noticeable LMS Difference") +
  xlab("Adaptation level") +
  theme_bw() +
  
  # Individual sessions
  geom_line(aes(group=session), alpha = .4) +

  # # Medians over sessions
  # stat_summary(aes(group=1),
  #              fun.y = median,
  #              size = 1,
  #              geom = "line",
  #              na.rm=TRUE) +
  
  # Point ranges median +- SEM(edian)
  geom_pointrange(stat="summary",
                fun.y = median,
                fun.ymin = medianMinusSEM,
                fun.ymax = medianPlusSEM,
                na.rm=TRUE)
```
Threshold for detection of LMS flicker, expressed as the mean change in LMS excitation across L, M, and S-cone photoreceptors. Thresholds are normalized to each subjectsâ€™ median (across sessions) threshold on the low backgrounds (separately for melanopsin and LMS background pairs). Points indicate median across sessions; lines show thresholds obtained in the same experimental session.  Error bars indicate +/-1 standard error of the median.