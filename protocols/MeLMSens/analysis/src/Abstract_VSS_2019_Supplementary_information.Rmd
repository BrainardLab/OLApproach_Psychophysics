---
title: "Title"
subtitle: Supplementary information
author: Joris Vincent, Geoffrey K. Aguirre, David H. Brainard
output:
  word_document: default
  html_document:
    df_print: paged
---
```{r setup, echo=FALSE, message=FALSE}
library(tidyverse)
library(knitr)
library(stringr)
source('../lib/median_SEM.R')
```
```{r merge, echo=FALSE}
csvsPath = normalizePath("../../data/processed")
csvfiles = list.files(csvsPath, recursive = TRUE, pattern = 'results_.*.csv')

results_all = lapply(csvfiles,function(x) {
   read_csv(file.path(csvsPath,x), col_types = cols())
  }) %>%
  bind_rows
```
```{r munge, echo=FALSE}
results_clean = results_all %>%
  separate(datafile,into=c("marker","participant","session","acquisition"),sep="-") %>%
  select(-marker, -acquisition) %>%
  
  # Select only relevant columns
  select(participant, session, axis, adaptationLevel, fitThresholdContrast, fitJND) %>%
  
  # Recode adaptationLevel as factor
  mutate(adaptationLevel= factor(adaptationLevel,levels=c('low','high'))) %>%

  # Rename participants
  mutate(participant = recode_factor(participant, HERO_GKA = "P1", HERO_DHB = "P2", HERO_JXV = "P3")) %>%

  # Rename sessions
  mutate(session = factor(str_replace(session,'session_',''),ordered=TRUE))
```

```{r extract_JNDs, echo=FALSE}
JNDs = results_clean %>%
  # Convert to wide-format: separate columns for high/low
  select(-fitThresholdContrast) %>%
  spread(key = adaptationLevel, value = fitJND)
```

```{r normalize_JNDs, echo=FALSE}
JNDs = JNDs %>%
  # Normalize to median(low) -- median across sessions per participant per axis
  group_by(participant,axis) %>%
  mutate(high = high/median(low),
         low = low/median(low))
```

```{r plot_JNDs, echo=FALSE}
JNDs %>% 
  # Convert back to tall: separate rows for high/low
  gather(low,high,key='adaptationLevel',value='JND') %>%
  mutate(adaptationLevel=factor(adaptationLevel,levels=c('low','high'))) %>%

  # Plot
  ggplot() +
  aes(x = adaptationLevel, y = JND) +
  facet_grid(participant ~ axis) +
  ylab("Just Noticeable LMS Difference \n(normalized to participant-median of low condition)") +
  xlab("Adaptation level") +
  theme_bw() +
  
  # Individual sessions
  geom_line(aes(group=session), alpha = .4) +

  # # Medians over sessions
  # stat_summary(aes(group=1),
  #              fun.y = median,
  #              size = 1,
  #              geom = "line",
  #              na.rm=TRUE) +
  
  # Point ranges median +- SEM(edian)
  geom_pointrange(stat="summary",
                fun.y = median,
                fun.ymin = medianMinusSEM,
                fun.ymax = medianPlusSEM,
                na.rm=TRUE) 
```
Just Noticeable Differences in (flickering) LMS excitation, expressed as the mean change in LMS excitation across L, M, and S-cone photoreceptors and across increment and decrement components of flicker stimulus. JNDs are normalized to each participants' median (across sessions) fit JND on the `low` excitation backgrounds (separately for LMS and melanopic background pairs). Lines indicate separate sessions, bold points indicate median across sessions with vertical error bars indicating +-1 Standard Error of the Median.

```{r table_JNDs, echo=FALSE}
summaryJNDs = JNDs %>% 
  # # Convert back to tall: separate columns for high/low, but separate rows for quick/fit/measured
  # unite(low_fit,high_fit,col='fit') %>%
  # unite(low_quick, high_quick, col='quick') %>%
  # unite(low_measured,high_measured,col='measured') %>%
  # gather(quick,fit,measured,key = 'measured',value='JND', factor_key = FALSE) %>%
  # separate(JND, into=c('low','high'), sep='_', convert=TRUE) %>%
  # mutate(measured = factor(measured, levels = c('quick','fit','measured'))) %>%
  
  group_by(participant, axis) %>%
  summarise(p = t.test(high,low,paired=TRUE)$p.value,
            t = t.test(high,low,paired=TRUE)$statistic,
            low_sem = SEMedian(low),
            high_sem = SEMedian(high),
            low = median(low, na.rm=TRUE),
            high = median(high, na.rm=TRUE)) %>%
  arrange(axis, participant) %>%
  select(participant, axis, low, low_sem, high, high_sem, t, p)

summaryJNDs %>%
  kable(digits = 4)
```

Median nominal JND was higher on the high LMS background than on the low background for each participant (DHB, GKA and JXV; by a factor of 4.14, 3.81 and 4.50 respectively). The JNDs calculated from the measured stimulus change the scaling factors (3.25, 4.21 and 3.18, respectively), but not the overall pattern that JNDs are higher on the high background than on the low background. Weber's law would predict that JNDs would increase by a factor of 4.5; for the nominal JNDs, this seems to hold roughly true for 2 of 3 participants.

Between the melanopic backgrounds, there was no single direction of difference in nominal JND; for two observers, JND was roughly equal between the high and low backgrounds (DHB = 1.02, JXV = 1.03), while for the the third observer it was lower on the high background (GKA = 0.89). The JNDs calculated from the measured stimulus change the scaling factors (1.19, 0.97 and 0.63, respectively), but no overall pattern emerges here either.

Student' t-statistics and corresponding p-values are presented in the table, but since these represent 4 pairs of samples per participant per axis, interpretation of these is cautioned against.